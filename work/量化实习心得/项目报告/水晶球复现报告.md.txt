# 一、任务简介


“水晶球”是兴业证券发布的，针对上证50etf的预测体系。它利用所选择的期权因子，根据其数值给出相应的打分，用各个因子的总分来预测上证50etf在下一交易日的涨跌情况。


## # 本次任务主要分为如下几个步骤：
1. 计算“水晶球“择时体系选用的因子，并且在原有因子上进行改进
2. 利用分类模型给各个因子打分
3. 根据总分与第二天实际涨幅，计算出预测准确率，并且进行回测


# 二、因子计算与选取


### 2.1 隐含波动率重算


由于优矿上隐含波动率( Implied Volatility,  IV)数值存在问题，我们利用优矿的**BSMImpliedVolatity**接口，对隐波进行重新计算，得到结果与期权计算器计算结果吻合。


### 2.2 因子计算


优矿内置文档” 50ETF期权7. 期权择时指数“中演示了 Put Call Implied Volatility Difference（PCIVD, 平值看跌看涨期权隐含波动率差）作为50etf择时因子的良好效果，因此我们同样考虑PCIVD作为因子，并取其比值代替差值。类似的变量包括：


- 近月平值认沽iv / 近月 平值 认购iv
- 次近月 平值 认沽iv / 次近月 平值 认购iv
- 次近月 平值 认沽iv / 近月 平值 认沽iv
- 次近月 平值 认购iv / 近月 平值 认购 iv
- 当天（近月 平值 认沽iv - 近月 平值 认购iv） / 昨天（近月 平值 认沽iv - 近月 平值 认购iv）
- 当天（次近月 平值 认沽iv - 次近月 平值 认购iv） / 昨天（次近月 平值 认沽iv - 次近月 平值 认购iv）


”水晶球“选取波动率倾斜指标作为因子之一，波动率倾斜程度(iv_skew)计算公式如下：


$$
iv\_skew =\frac{std(iv)}{ iv^*}
$$
其中，$std()$为标准差函数，$iv$为当前所有期权的波动率向量，$iv^*$为综合波动率，它是期权波动率按找成交量加权平均之后的结果。 参考该指标，我们计算出如下因子：


- 近月认购期权波动率倾斜
- 近月认沽期权波动率倾斜
- 此近月认购期权波动率倾斜
- 此近月认沽期权波动率倾斜


水晶球以及大多数期权择时策略中均选用了认购认沽期权成交量比(cpr)以及他的上一日差分作为因子，我们同样将其加入待考虑因子中：
-  认购认沽期权成交量比(cpr)
- 当日cpr - 上一交易日cpr


为了反应长期或是短期趋势，我们分别加入长短均线作为因子：
- 5日移动平均值
- 20日移动平均值


# 三、分类模型选取


当前比较常用的分类模型有KNN，决策树，logistic回归，朴素贝叶斯，支持向量机等等，其中KNN算法的k值难以确定，而且受异常值影响较大；logistic好解释，但是单因子时容易欠拟合；朴素贝叶斯对连续的自变量预测效果不好；支持向量机难以调参，且难以解释，因此最终选取决策树作为分类模型。


决策树以分类条件下分类后样本信息熵最小（或是基尼系数与信息比率）为目标，迭代计算出最优的分类规则，类似一棵树状结构。


决策树优点在于容易解释，且可展示，缺点是容易过拟合，需要通过恰当的剪枝防止过拟合。此次我们调节的剪枝变量为决策树深度，深度为一的决策树即寻找最优分类阈值，当大于该阈值时分为1类的概率最大，且小与该阈值时分为0的概率最大，以变量cpr为例，阈值为a，一层决策树如图所示：


但是此时往往是欠拟合的，拟合效果并不好，因为如果cpr大到一定程度的话，下一期很可能时跌的，所以考虑两层决策树如下：




这样就在一定程度上得到了较好的拟合。但是如果不规定决策树层数，是极其容易过拟合的，通过迭代，我们选择5层深度的决策树，作为分类模型。




# 四、模型拟合与因子选取


### 50etf涨幅离散化
我么预测的变量是**50etf现货收盘价涨幅**，如果按照大于0为涨小与0为跌的话，分类效果并不好，因为0附近掺杂了太多随机扰动。


为此根据涨幅的三分位数，我们选择0.003作为涨幅阈值，大于0.003则预测为涨，小与-0.003则预测为跌，位于-0.003与0.003中间则为震荡，此时涨、跌、震荡的历史样本接近相等，避免了样本不均匀的问题。

### 分类模型训练集选取


决定分类算法好坏的主要因素有：
- 分类算法选取与参数调节
- 训练集的选取
- 分类特征的抽取（特征工程）


在完成分类算法的选取以及参数的调整之后（5层决策树），我们需要决定选何时的数据作为训练集。为了预测2017年当前的50etf增长，我们需要选择市场行情和目前相当的数据作为训练集，由于16年中旬以前市场变动幅度非常大，十分不稳定（见下图），因此我们选取了**2016-06-01以后**的数据用以训练和测试。



 
### 分类模型特征选取


特征即因子，我们需要从上述多个因子中选择最适合模型拟合的因子。
我们确定检验因子组合好坏的变量为2017年模型预测准确率，从上述所有因子中遍历所有的无序子集，作为测试的因子组合，并且计算出模型准确率。通过不断的迭代和选取，我们最终确定最终因子组合如下：


1.  认购认沽期权成交量比(cpr)
2.  当日cpr - 上一交易日cpr (delta_cpr)
3.  近月平值认沽iv / 近月 平值 认购iv (PCIVD)
4.  次近月 平值 认购iv / 近月 平值 认购 iv
5. 近月认购期权波动率倾斜 (iv_skew)


其中1,2,3,5四个因子与“水晶球”择时体系相似，预测2017年数据准确率为65.2%， 利用2016年6月以后数据交叉验证准确率均值保持在56%左右，初步认为模型预测准确率较好。


上述五个因子从如下几个方面反应了市场情绪：
- cpr与delta_cpr反应了市场中看涨的认与看跌的人的比率，以及其变动情况
- PCIVD指标反应了认沽与认购期权隐含波动率曲线最低点的比值，从位置的角度反应了认沽认购隐含波动率曲线的关系
- iv_skew反应了波动率曲线的倾斜程度，该指标越大，则波动率倾斜越厉害，它从结构角度反应了隐含波动率曲线的关系



### 每日预测结果汇总




从4月28日到5月12日，一共预测八天，其中仅仅错判5月8日一次，并且在5月5日成功预测出“V”型拐点，短期来看预测准确率较高，详细预测结果见下表：



 基准期 预测目标日期涨幅 预测分值（满分5分）
 2017/4/28 -0.34% 2
 2017/5/2 -0.30% 2
 2017/5/3 -0.22% 2
 2017/5/4 -0.30% 3
 2017/5/5 0.22% 3
 2017/5/8 -0.13% 3
 2017/5/9 0.26% 3
 2017/5/10 0.56% 3
 2017/5/11 1







# 五、回测




我们对50etf进行纯多头交易，当打分超过3分时看多，全仓杀入，否则平仓，进行回测，费用取万2.5。




### 17年数据回测




由于训练集采取的是2016年下半年样本，我们对2017年数据进行预测并且回测，得到回测结果见下图。

可以看出，虽然年化收益较高于基准，回撤也比较小，但是数据样本较少，且较长时间没有发生交易，所以回撤小在情理之中。总体来看2017年回测效果并不好。


 



### 16年中期以前样本回测




为了验证模型的泛化能力，我们用16年6月1日以前的所有历史数据进行回测，检验在波动幅度非常大的市场中策略是否依然有效，回测结果见下图。

图中发现策略在15年上半年表现交叉，15年中期尤其是八月份表现良好，拉开了与基准的差距，往后则表现一般（与基准保持持平，说明涨与跌被等概率的预测到了）。





 



# 六、总结与规划




水晶球的思想即是通过期权数据（包括波动率差异、波动率结构、成交量等等）反应市场行情与投资者情绪，从而预测50etf现货涨跌情况。




此次水晶球复现在原有基础上，通过分类模型选取与因子迭代，进行了细微的改变，并取得了一定的成果。在接下来的时间里，我们会主要完成如下事项：




- 每日水晶球预测报告的撰写、预测准确度的监控，每隔一段时间后进行总结与汇报

- 对接优矿模拟盘，实现模拟交易










